#!/bin/sh

# Copyright Â© 2009-2015 Jakub Wilk
#
# This package is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; version 2 dated June, 1991.

if [ $# -ne 1 ]
then
  printf '%s <version>\n' "$0" >&2
  exit 1
fi
set -e -x
pwd="$PWD"
name=$(sed -n -e '/^\([[:alnum:]-]\+\).*/ { s//\1/; p; q}' doc/changelog)
version="$1"
sourceroot=$(mktemp -d -t "$name-source-XXXXXX")
export TAR_OPTIONS='--owner root --group root --mode a+rX --format ustar'
export GZIP='-9 -n'
hg archive -r "$version" "$sourceroot/$name-$version"
cd "$sourceroot"/*
rm .hg*
rm .travis.yml
rm -r private/
cd ..
tar -czf "$pwd/$name-$version.tar.gz" */
rm -r "$sourceroot"
